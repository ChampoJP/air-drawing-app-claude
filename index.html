<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dibujo en el Aire - Detección de Movimiento</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .camera-container {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            background: black;
            max-width: 800px;
            width: 100%;
            display: none;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
        }

        .status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 20;
        }

        .drawing-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff4444;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .drawing-indicator.active {
            opacity: 1;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .control-group {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .start-btn {
            background: linear-gradient(145deg, #51cf66, #40c057);
            font-size: 16px;
            padding: 15px 30px;
        }

        .clear-btn {
            background: linear-gradient(145deg, #ffd43b, #fab005);
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider {
            width: 100px;
            height: 5px;
            border-radius: 5px;
            background: rgba(255,255,255,0.3);
            outline: none;
            cursor: pointer;
        }

        .instructions {
            margin-top: 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
            max-width: 600px;
        }

        .instructions h3 {
            margin-bottom: 10px;
            color: #ffd43b;
        }

        .error, .success, .info {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            white-space: pre-line;
        }

        .error {
            background: rgba(255,0,0,0.8);
            color: white;
        }

        .success {
            background: rgba(0,255,0,0.8);
            color: white;
        }

        .info {
            background: rgba(0,150,255,0.8);
            color: white;
        }

        .debug-info {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-line;
            max-height: 300px;
            overflow-y: auto;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎨 Dibujo en el Aire</h1>
        <p>Dibuja moviendo tu mano frente a la cámara</p>
    </div>

    <div class="camera-container" id="cameraContainer">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="status" id="status">Cámara activa - Mueve tu mano para dibujar</div>
        <div class="drawing-indicator" id="drawingIndicator"></div>
    </div>

    <div class="controls">
        <button id="startBtn" class="start-btn">🎥 Iniciar Cámara</button>
        <button id="debugBtn" class="clear-btn">🔧 Diagnóstico</button>
        
        <div class="control-group hidden" id="drawingControls">
            <button id="toggleDrawing">✋ Pausar Dibujo</button>
            <button id="clearCanvas" class="clear-btn">🧹 Limpiar</button>
            <button id="saveDrawing">💾 Guardar</button>
        </div>

        <div class="control-group hidden" id="colorControls">
            <label style="color: white;">Color:</label>
            <input type="color" id="colorPicker" class="color-picker" value="#ff0000">
        </div>

        <div class="control-group hidden" id="sizeControls">
            <label style="color: white;">Grosor:</label>
            <input type="range" id="brushSize" class="slider" min="1" max="20" value="5">
            <span id="sizeValue" style="color: white;">5</span>
        </div>

        <div class="control-group hidden" id="sensitivityControls">
            <label style="color: white;">Sensibilidad:</label>
            <input type="range" id="sensitivity" class="slider" min="10" max="100" value="50">
            <span id="sensitivityValue" style="color: white;">50</span>
        </div>
    </div>

    <div id="messageArea"></div>

    <div class="instructions">
        <h3>📋 Instrucciones:</h3>
        <p><strong>1.</strong> Haz clic en "Iniciar Cámara" y permite el acceso</p>
        <p><strong>2.</strong> Mueve tu mano frente a la cámara para dibujar</p>
        <p><strong>3.</strong> Los movimientos rápidos crean trazos</p>
        <p><strong>4.</strong> El indicador rojo se activa cuando estás dibujando</p>
    </div>

    <script>
        console.log('🚀 Iniciando aplicación...');
        
        let app = {
            video: null,
            canvas: null,
            ctx: null,
            isDrawing: false,
            drawingEnabled: true,
            lastPosition: null,
            currentColor: '#ff0000',
            brushSize: 5,
            sensitivity: 50,
            motionCanvas: null,
            motionCtx: null,
            previousFrame: null,
            drawingTimeout: null,

            init: function() {
                console.log('🔧 Inicializando aplicación...');
                
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.motionCanvas = document.createElement('canvas');
                this.motionCtx = this.motionCanvas.getContext('2d');
                
                this.setupEventListeners();
                this.showMessage('info', '✅ Aplicación lista. Haz clic en "Iniciar Cámara"');
            },

            setupEventListeners: function() {
                console.log('🔗 Configurando eventos...');
                
                document.getElementById('startBtn').onclick = () => {
                    console.log('🎬 Botón Iniciar presionado');
                    this.startCamera();
                };
                
                document.getElementById('debugBtn').onclick = () => {
                    console.log('🔧 Botón Diagnóstico presionado');
                    this.runDiagnostic();
                };
                
                document.getElementById('toggleDrawing').onclick = () => this.toggleDrawing();
                document.getElementById('clearCanvas').onclick = () => this.clearCanvas();
                document.getElementById('saveDrawing').onclick = () => this.saveDrawing();
                
                document.getElementById('colorPicker').onchange = (e) => {
                    this.currentColor = e.target.value;
                };
                
                document.getElementById('brushSize').oninput = (e) => {
                    this.brushSize = parseInt(e.target.value);
                    document.getElementById('sizeValue').textContent = e.target.value;
                };
                
                document.getElementById('sensitivity').oninput = (e) => {
                    this.sensitivity = parseInt(e.target.value);
                    document.getElementById('sensitivityValue').textContent = e.target.value;
                };
            },

            showMessage: function(type, message) {
                const messageArea = document.getElementById('messageArea');
                const messageDiv = document.createElement('div');
                messageDiv.className = type;
                messageDiv.textContent = message;
                
                // Limpiar mensajes anteriores del mismo tipo
                const existingMessages = messageArea.querySelectorAll('.' + type);
                existingMessages.forEach(msg => msg.remove());
                
                messageArea.appendChild(messageDiv);
                
                // Auto-remover después de 5 segundos (excepto errores)
                if (type !== 'error') {
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.remove();
                        }
                    }, 5000);
                }
            },

            runDiagnostic: function() {
                console.log('🔬 Ejecutando diagnóstico...');
                
                let info = [];
                info.push('🔍 DIAGNÓSTICO DEL SISTEMA:');
                info.push('');
                info.push('Navegador: ' + navigator.userAgent);
                info.push('Protocolo: ' + window.location.protocol);
                info.push('URL: ' + window.location.href);
                info.push('');
                
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    info.push('✅ getUserMedia: Soportado');
                    
                    navigator.mediaDevices.enumerateDevices()
                        .then(devices => {
                            const cameras = devices.filter(device => device.kind === 'videoinput');
                            info.push('📷 Cámaras detectadas: ' + cameras.length);
                            
                            cameras.forEach((camera, index) => {
                                info.push('  ' + (index + 1) + '. ' + (camera.label || 'Cámara sin nombre'));
                            });
                            
                            if (navigator.permissions) {
                                navigator.permissions.query({name: 'camera'})
                                    .then(permission => {
                                        info.push('🔐 Permisos de cámara: ' + permission.state);
                                        this.showDebugInfo(info.join('\n'));
                                    })
                                    .catch(() => {
                                        info.push('⚠️ No se pueden verificar permisos');
                                        this.showDebugInfo(info.join('\n'));
                                    });
                            } else {
                                info.push('⚠️ API de permisos no disponible');
                                this.showDebugInfo(info.join('\n'));
                            }
                        })
                        .catch(() => {
                            info.push('❌ Error al enumerar dispositivos');
                            this.showDebugInfo(info.join('\n'));
                        });
                } else {
                    info.push('❌ getUserMedia: NO soportado');
                    this.showDebugInfo(info.join('\n'));
                }
            },

            showDebugInfo: function(info) {
                const messageArea = document.getElementById('messageArea');
                
                // Remover diagnósticos anteriores
                const existingDebug = messageArea.querySelectorAll('.debug-info');
                existingDebug.forEach(debug => debug.remove());
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'debug-info';
                debugDiv.textContent = info;
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '❌ Cerrar';
                closeBtn.style.marginTop = '10px';
                closeBtn.onclick = () => debugDiv.remove();
                
                debugDiv.appendChild(closeBtn);
                messageArea.appendChild(debugDiv);
                
                console.log(info);
            },

            startCamera: function() {
                console.log('🎬 Iniciando cámara...');
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.showMessage('error', '❌ Tu navegador no soporta acceso a la cámara.\n\nUsa Chrome, Firefox o Edge actualizado.');
                    return;
                }

                this.showMessage('info', '🔄 Solicitando acceso a la cámara...\n\nSi aparece una notificación, haz clic en "Permitir"');

                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };

                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        console.log('✅ Stream obtenido');
                        
                        this.video.srcObject = stream;
                        
                        this.video.onloadedmetadata = () => {
                            console.log('📺 Metadata cargada');
                            this.video.play();
                            this.setupCanvas();
                            this.startMotionDetection();
                            this.showControls();
                            this.showMessage('success', '✅ ¡Cámara conectada! Mueve tu mano para dibujar.');
                        };
                        
                        this.video.onerror = (e) => {
                            console.error('❌ Error de video:', e);
                            this.showMessage('error', '❌ Error al reproducir el video de la cámara');
                        };
                    })
                    .catch(err => {
                        console.error('🚫 Error de cámara:', err);
                        
                        let errorMsg = '❌ Error: ' + err.name;
                        
                        switch(err.name) {
                            case 'NotAllowedError':
                                errorMsg = '🚫 Acceso denegado.\n\nSOLUCIÓN:\n1. Haz clic en el candado 🔒 junto a la URL\n2. Cambia "Cámara" a "Permitir"\n3. Recarga la página (F5)';
                                break;
                            case 'NotFoundError':
                                errorMsg = '📷 No se encontró cámara.\n\nVerifica:\n• ¿Tienes cámara conectada?\n• ¿Funciona en otras apps?\n• ¿Es laptop? Revisa teclas Fn';
                                break;
                            case 'NotReadableError':
                                errorMsg = '⚠️ Cámara ocupada.\n\nCierra:\n• Zoom, Teams, Skype\n• Otras pestañas del navegador\n• Reinicia el navegador';
                                break;
                            default:
                                errorMsg = '❌ Error: ' + err.message + '\n\nPrueba:\n• Recargar la página\n• Usar modo incógnito\n• Cambiar de navegador';
                        }
                        
                        this.showMessage('error', errorMsg);
                    });
            },

            setupCanvas: function() {
                console.log('🎨 Configurando canvas...');
                
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                this.motionCanvas.width = this.video.videoWidth;
                this.motionCanvas.height = this.video.videoHeight;
                
                this.ctx.lineJoin = 'round';
                this.ctx.lineCap = 'round';
                this.ctx.globalAlpha = 0.8;
                
                document.getElementById('cameraContainer').style.display = 'block';
            },

            startMotionDetection: function() {
                console.log('👋 Iniciando detección de movimiento...');
                
                const detectMotion = () => {
                    if (this.video.videoWidth === 0 || this.video.paused) {
                        requestAnimationFrame(detectMotion);
                        return;
                    }

                    this.motionCtx.drawImage(this.video, 0, 0, this.motionCanvas.width, this.motionCanvas.height);
                    const currentFrame = this.motionCtx.getImageData(0, 0, this.motionCanvas.width, this.motionCanvas.height);
                    
                    if (this.previousFrame && this.drawingEnabled) {
                        const motionData = this.calculateMotion(currentFrame, this.previousFrame);
                        this.processMotion(motionData);
                    }
                    
                    this.previousFrame = currentFrame;
                    requestAnimationFrame(detectMotion);
                };
                
                requestAnimationFrame(detectMotion);
            },

            calculateMotion: function(current, previous) {
                const motionData = {
                    totalMotion: 0,
                    centerX: 0,
                    centerY: 0,
                    motionPixels: 0
                };

                const threshold = 30;
                let motionX = 0;
                let motionY = 0;
                let motionCount = 0;

                for (let i = 0; i < current.data.length; i += 16) {
                    const pixelIndex = i / 4;
                    const x = pixelIndex % this.motionCanvas.width;
                    const y = Math.floor(pixelIndex / this.motionCanvas.width);

                    const rDiff = Math.abs(current.data[i] - previous.data[i]);
                    const gDiff = Math.abs(current.data[i + 1] - previous.data[i + 1]);
                    const bDiff = Math.abs(current.data[i + 2] - previous.data[i + 2]);
                    const totalDiff = rDiff + gDiff + bDiff;

                    if (totalDiff > threshold) {
                        motionData.totalMotion += totalDiff;
                        motionX += x;
                        motionY += y;
                        motionCount++;
                    }
                }

                if (motionCount > 0) {
                    motionData.centerX = motionX / motionCount;
                    motionData.centerY = motionY / motionCount;
                    motionData.motionPixels = motionCount;
                }

                return motionData;
            },

            processMotion: function(motionData) {
                const minMotion = this.sensitivity * 10;
                const isSignificantMotion = motionData.totalMotion > minMotion && motionData.motionPixels > 100;
                
                if (isSignificantMotion) {
                    const x = motionData.centerX;
                    const y = motionData.centerY;
                    
                    if (this.lastPosition && this.isDrawing) {
                        const distance = Math.sqrt(
                            Math.pow(x - this.lastPosition.x, 2) + 
                            Math.pow(y - this.lastPosition.y, 2)
                        );
                        
                        if (distance < 200) {
                            this.drawLine(this.lastPosition.x, this.lastPosition.y, x, y);
                        }
                    }
                    
                    this.lastPosition = { x, y };
                    
                    if (!this.isDrawing) {
                        this.isDrawing = true;
                        this.showDrawingIndicator(true);
                    }
                    
                    this.resetDrawingTimeout();
                } else if (this.isDrawing) {
                    this.drawingTimeout = setTimeout(() => {
                        this.isDrawing = false;
                        this.lastPosition = null;
                        this.showDrawingIndicator(false);
                    }, 200);
                }
            },

            resetDrawingTimeout: function() {
                if (this.drawingTimeout) {
                    clearTimeout(this.drawingTimeout);
                }
            },

            drawLine: function(x1, y1, x2, y2) {
                this.ctx.beginPath();
                this.ctx.moveTo(x1, y1);
                this.ctx.lineTo(x2, y2);
                this.ctx.strokeStyle = this.currentColor;
                this.ctx.lineWidth = this.brushSize;
                this.ctx.stroke();
            },

            showDrawingIndicator: function(show) {
                const indicator = document.getElementById('drawingIndicator');
                if (show) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            },

            showControls: function() {
                console.log('🎮 Mostrando controles...');
                document.getElementById('drawingControls').classList.remove('hidden');
                document.getElementById('colorControls').classList.remove('hidden');
                document.getElementById('sizeControls').classList.remove('hidden');
                document.getElementById('sensitivityControls').classList.remove('hidden');
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('debugBtn').style.display = 'none';
            },

            toggleDrawing: function() {
                this.drawingEnabled = !this.drawingEnabled;
                const btn = document.getElementById('toggleDrawing');
                if (this.drawingEnabled) {
                    btn.textContent = '✋ Pausar Dibujo';
                    btn.style.background = 'linear-gradient(145deg, #ff6b6b, #ee5a52)';
                } else {
                    btn.textContent = '▶️ Reanudar Dibujo';
                    btn.style.background = 'linear-gradient(145deg, #51cf66, #40c057)';
                    this.isDrawing = false;
                    this.showDrawingIndicator(false);
                }
            },

            clearCanvas: function() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.showMessage('info', '🧹 Canvas limpiado');
            },

            saveDrawing: function() {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvas.width;
                tempCanvas.height = this.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCtx.drawImage(this.video, 0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(this.canvas, 0, 0);
                
                const link = document.createElement('a');
                link.download = 'dibujo-aire-' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.png';
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
                
                this.showMessage('success', '💾 Imagen guardada');
            }
        };

        // Inicializar cuando se carga la página
        window.onload = function() {
            console.log('📄 Página cargada, inicializando app...');
            app.init();
        };

        // Manejo de errores globales
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('💥 Error JavaScript:', {
                mensaje: msg,
                archivo: url,
                linea: lineNo,
                columna: columnNo,
                error: error
            });
            
            if (app && app.showMessage) {
                app.showMessage('error', '💥 Error de JavaScript: ' + msg + '\n\nRecarga la página (F5)');
            }
            
            return false;
        };
    </script>
</body>
</html>
